# 交通标志识别及响应
**基本性能要求:**
- 自车应能够识别交通信号灯,并且应能够做到红灯时在车辆停止线之前停车,绿灯时及时通行。
- 自车在通过交通信号灯时应保证车辆行驶稳定,避免出现过大的加速度。

**测试场景:**
- 自车在左转车道通过有信号灯的交叉路口,左转信号灯为红色,自车应能在停止线前及时停车,在信号灯变为绿灯后起步通过交叉路口。
- 自车在直行车道通过有信号灯的交叉路口,直行信号灯为红色,自车应能在停止线前及时停车,在信号灯变为绿灯后起步通过交叉路口。
- 自车在右转车道通过有信号灯的交叉路口,右转信号灯为红色,自车应能在停止线前及时停车,在信号灯变为绿灯后起步通过交叉路口。
- 自车在左转车道通过有信号灯的交叉路口,跟随一辆大货车行驶,路口的信号灯为绿灯,自车跟着大货车在十字路口左转,当大货车左转通过十字路口时,自车还在停止线内,路口信号灯转为红色,自车应能在停止线前及时停车,在信号灯变为绿灯后起步通过交叉路口。
- 自车在直行车道通过有信号灯的交叉路口,信号灯形态为黄闪灯,自车应能够安全减速通过路口。

**传感器需求:**
- Camera
- HD MAP
- Lidar
- Radar

**autoware 交通灯识别**: 深度学习检测结果与external system information(V2X ???)冗余得到交通灯颜色, 高精地图得到距离信息.

## 简介  
**apollo 交通灯识别:**  
为了覆盖全部的情况，交通信号灯感知模块提供了5种信号灯状态输出:  
- 红
- 黄
- 绿
- 黑
- 未知

仅仅使用一个固定视野的摄像头无法识别所有的信号灯。存在这种限制的原因是:  
- 感知范围应该大于100米
- 信号灯的高度和路口的宽度变化范围很大

使用了2个摄像头来扩大感知范围:  
-  一个**远距摄像头**，焦距是25毫米，被用来观察前方远距离的信号灯。远距摄像头捕获的信号灯在图片上展现的非常大而且容易被检测。但是远距摄像头的视野有限制，如果路线不够直或者车辆太过于靠近信号灯，经常无法拍摄到信号灯。  
- 一个**广角摄像头**。焦距是6毫米，是对远距摄像头视野不足的补充。

## 预处理阶段  
没有必要在每一帧的图像中去检测信号灯。信号灯的变化频率是很低的而且计算机的资源也有限。通常，从不同摄像头输入的图像信息会几乎同时的到达，但是只有一个会进入管道的处理阶段。因此图像的遴选和匹配是很必要的。

### 输入输出  
#### 输入数据  
- 可以通过订阅以下topic来获取不同摄像头的图像数据:  
    - `/apollo/sensor/camera/traffic/image_long`
    - `/apollo/sensor/camera/traffic/image_short`  
- 定位信息
- 高精地图

#### 输出数据  
  - 被选择的摄像头输出的的图像信息
  - 从世界坐标系投射到图像坐标系的信号灯边界盒

### 摄像头选择  
HD MAP输出边界盒信息:   
```protobuf
signal info:
id {
  id: "xxx"
}
boundary {
  point { x: ...  y: ...  z: ...  }
  point { x: ...  y: ...  z: ...  }
  point { x: ...  y: ...  z: ...  }
  point { x: ...  y: ...  z: ...  }
}
```

输入和输出:  
> 输入数据: 摄像头图像信息, 边界盒信息(交通灯的ID和四个脚点坐标信息)
> 输出数据: 带有颜色标签的边界盒信息

### 调整  
被定位信息、校准信息和高精地图信息影响的投射点 ***不是完全可靠的*** 。通过投射的信号灯位置计算的一个大的兴趣区域（Region of Interest ROI）被用来确定信号灯精确的边界盒。

### 识别  
信号灯识别是一个常规的卷积神经网络鉴别任务，它接收带有ROI信息的图像和一组边界盒信息作为输入数据。输出数据是一个边界盒信息加概率信息, 表示每个边界盒是黑色、红色、黄色和绿色的概率。当且仅当概率足够大时，有最大概率的类别会被识别为信号灯的状态。否则信号灯状态被设置为未知，表示状态未确定。  

### 修正  
- 因为信号灯可能会闪烁或者被遮挡，并且识别阶段也 ***并不是*** 完美的，输出的信号灯状态可能不是真正的状态。修正信号灯状态是很有必要的。  
- 如果修正器接收到一个确定的信号灯状态例如红色或者绿色，则修正器保存该状态并直接输出。如果接收到黑色或者未知，修正器会检测状态保存列表。如果信号灯状态已经确定持续了一段时间，那么将保存的状态输出。否则将黑色或者未知输出。  
- 因为时间顺序关系的存在，黄色只会在绿色之后红色之前出现，所以为了安全的考虑，在绿色出现之前任何红色之后的黄色都会被设置为红色。


# 交叉路口通行

**基本性能要求:**
- 自车应能够识别交叉路口的车辆、非机动车和行人的通行状况,在行驶过程中应能够及时避让,保证安全通行;
- 自车在通过交叉路口时应能够保证稳定行驶,不应出现过大的横摆角速度;
- 自车在交叉路口转向通行之前应能够打开相应侧的转向灯。

**测试场景:**
- 自车在沿规划路径通过无红绿灯交叉路口的过程中,按目的地的不同,需要进行左转/右转/直行/掉头动作。自车应能够以合理的车速通过路口,并到达路径终点。
- 自车在沿规划路径通过无红绿灯交叉路口的过程中,按目的地的不同,需要进行左转/右转/直行/掉头动作。在交叉路口中,在道路左侧/右侧/对向存在单一的干扰车辆,其行驶轨迹将与自车的规划轨迹发生冲突。自车应能够以合理的车速安全通过交叉路口,同时不应与干扰车辆发生碰撞事故,并到达路径终点。
- 自车在沿规划路径通过有红绿灯交叉路口的过程中,按目的地的不同,需要进行左转/右转/直行/掉头动作。在交叉路口中,有行人或非机动车通过人行横道横穿马路,其路径将与自车发生冲突。自车应能够以合理的车速安全通过路口,同时避让行人和非机动车通行,并到达路径终点。

**传感器需求:**
- DGPS
- HD MAP
- Camera
- Lidar
- Radar
- Ultrasonic

# 行人和非机动车识别及避让

**基本性能要求:**
- 自车应能够探测行驶路线上的行人或者非机动车;
- 自车应能够避免与行驶路线上的行人或者非机动车发生碰撞;
- 自车应能够通过减速跟随、绕行、停车等待行人或者非机动车离开行驶路线等方式到达测试终点。

**测试场景:**
- 自车在直线车道匀速行驶,前方遇到缓慢前行的VRU,则自车应能够减速跟随或者绕行到达测试终点,或者停车并通知驾驶员进行接管。
- 自车在直线车道匀速行驶,前方遇到对向缓慢前行的VRU,则自车应能够绕行到达测试终点,或者停车并通知驾驶员进行接管。
- 自车在直线车道U型调头,掉头后遇到横穿马路的VRU,则自车应能够等待LidarVRU离开车辆的行驶路线后继续前进,或者停车并通知驾驶员进行接管。
- 自车在直线车道匀速行驶,在自车前方有VRU横穿马路,则自车应能够等待VRU离开自车的行驶路线后继续前进,或者停车并通知驾驶员进行接管。

**传感器需求:**
- DGPS
- Camera
- Lidar
- Ultrasonic